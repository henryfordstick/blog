# React Nativeæ¡¥æ¥ä¹‹è·¯
React Native æ˜¯Facebookå¼€æºçš„è·¨å¹³å°æ¡†æ¶ï¼Œä¸ºäº†è®²è§£æ–¹ä¾¿ï¼Œæˆ‘å°†React Nativeç®€ç§°ä¸ºRNã€‚RNå®˜ç½‘è¯´èƒ½ç”¨JavaScriptç¼–å†™åŸç”Ÿç§»åŠ¨åº”ç”¨ï¼Œè€Œä¸”ç”¨JSè§£å†³ä¸äº†çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å‘¼å«åŸç”ŸåŒå­¦ã€‚
é‚£ä¹ˆè¿™é‡Œå°±ç‰µæ‰¯åˆ°äº†RNä¸Nativeçš„é€šä¿¡é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»ä¸‹é¢å‡ ä¸ªè¯é¢˜ç”±æµ…å…¥æ·±æ¢è®¨ä¸€ä¸‹ï¼ï¼ï¼
- è¯´è¯´RNçš„æ•…äº‹
- RNä¸ºä»€ä¹ˆèƒ½ç¼–å†™åŸç”Ÿåº”ç”¨
- RNæ˜¯å¦‚ä½•æ„é€ åº”ç”¨å¸ƒå±€çš„
- æ ¹æ®é¡¹ç›®å” æ¡¥æ¥
- ç›¸å…³é“¾æ¥


## è¯´è¯´RNçš„æ•…äº‹
Facebook æ›¾è‡´åŠ›äºä½¿ç”¨ HTML5 è¿›è¡Œç§»åŠ¨ç«¯çš„å¼€å‘ ï¼Œç»“æœå‘ç°åœ¨æ€§èƒ½æ–¹é¢ä¸åŸç”Ÿçš„ App ç›¸å·®è·è¶Šæ¥è¶Šå¤§ã€‚æœ€ç»ˆï¼ŒFacebook æ”¾å¼ƒäº†RN æŠ€æœ¯è·¯çº¿ï¼Œäº 2015å¹´3æœˆæ­£å¼å‘å¸ƒäº† RN æ¡†æ¶ï¼Œæ­¤æ¡†æ¶ä¸“æ³¨äºç§»åŠ¨ç«¯ App çš„å¼€å‘ã€‚

åœ¨æœ€åˆå‘å¸ƒçš„ç‰ˆæœ¬ä¸­ï¼Œ RN æ¡†æ¶åªç”¨äºå¼€å‘ iOS å¹³å°çš„ App, 2015å¹´9æœˆï¼Œ Facebook å‘å¸ƒäº†æ”¯æŒ Android å¹³å°çš„ RN æ¡†æ¶ è‡³æ­¤ï¼Œ RN æ¡†æ¶çœŸæ­£å®ç°äº†è·¨å¹³å°çš„ç§»åŠ¨ App å¼€å‘ï¼Œæ­¤ä¸¾ç®€ç›´å°±æ˜¯ç§»åŠ¨ App å¼€å‘äººå‘˜çš„ç¦éŸ³ã€‚

## RNä¸ºä»€ä¹ˆèƒ½ç¼–å†™åŸç”Ÿåº”ç”¨
åœ¨è®²è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹RNçš„æ¶æ„å›¾ã€‚
![React Nativeæ¶æ„](/images/react-native-con.jpeg)
- ç»¿è‰²éƒ¨åˆ†æ˜¯åº”ç”¨å¼€å‘çš„éƒ¨åˆ†ï¼Œä¸šåŠ¡é€»è¾‘ä»£ç å°±åœ¨è¿™é‡Œã€‚
- è“è‰²éƒ¨åˆ†æ˜¯è·¨å¹³å°çš„ä»£ç å’Œå¼•æ“ï¼Œä¸€èˆ¬ä¸ä¼šæ”¹å†™è“è‰²éƒ¨åˆ†ã€‚
- é»„è‰²ä»£ç å¹³å°ç›¸å…³çš„ä»£ç ï¼Œåšå®šåˆ¶åŒ–çš„æ—¶å€™ä¼šæ·»åŠ ä¿®æ”¹ä»£ç ã€‚æ˜¯å„ä¸ªå¹³å°ç”¨æ¥åšæ¡¥æ¥(Bridge)çš„ã€‚
- çº¢è‰²éƒ¨åˆ†æ˜¯ç³»ç»Ÿå¹³å°çš„ä¸œè¥¿ã€‚çº¢è‰²ä¸Šé¢æœ‰ä¸€ä¸ªè™šçº¿ï¼Œè¡¨ç¤ºæ‰€æœ‰å¹³å°ç›¸å…³çš„ä¸œè¥¿éƒ½é€šè¿‡ Bridge éš”ç¦»å¼€æ¥äº†ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¼€å‘æ‰€å†™çš„JSä»£ç éƒ½åœ¨ç»¿è‰²éƒ¨åˆ†ï¼Œé»„è‰²éƒ¨åˆ†æ˜¯ç”¨ åŸä»£ç å†™çš„æ¡¥æ¥ç»„ä»¶ï¼Œå…¶ä»–éƒ¨åˆ†ä¸ç”¨æ¶‰åŠã€‚

æˆ–è®¸è¿™æ ·çš„è§£é‡Šæœ‰ç‚¹ç¬¼ç»Ÿï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸‹é¢è¯¦ç»†è®²è§£ä¸€ä¸‹RNçš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ã€‚
### RNçš„æ¶æ„
é‚£ä¹ˆæˆ‘ä»¬æŠŠå‰é¢æ¶æ„å›¾çš„çš„è™šçº¿ä¸Šé¢éƒ¨åˆ†å†ç”»è¯¦ç»†ç‚¹ï¼Œå°±å¾—åˆ°äº†ä¸‹é¢è¿™å¼ å›¾ğŸ˜ï¼

![RNåŸç†](/images/rn-bridge.jpg)

æˆ‘ä»¬å¯ä»¥æŠŠRNçš„æ•´ä¸ªæ¶æ„åˆ†ä¸ºä¸‰å±‚ï¼š
- ç¬¬ä¸€å±‚æ˜¯ç”¨Reactå†™çš„JSä»£ç å±‚ï¼ˆä¹Ÿå°±æ˜¯æ¶æ„å›¾ä¸­**ç»¿è‰²éƒ¨åˆ†**ï¼‰ï¼Œè¿™é‡Œçš„ä»£ç è·‘åœ¨JSå¼•æ“`JavaScriptCore`ä¸Šã€‚åœ¨Debugæ¨¡å¼ä¸‹è·‘åœ¨Chromeæµè§ˆå™¨çš„V8å¼•æ“ä¸Šï¼Œé€šè¿‡`Websocket`å‘é€åˆ°ç§»åŠ¨è®¾å¤‡ã€‚

- ç¬¬äºŒå±‚æ˜¯æ¡¥æ¥JSå’Œ Nativeã€‚åœ¨0.59æ‰€æœ‰çš„é€šä¿¡éƒ½éœ€è¦ç»è¿‡JSONåºåˆ—åŒ–ä»¥åé€šè¿‡Bridgeå¼‚æ­¥é€šä¿¡ã€‚0.59å¼€å§‹ç”¨äº†æ–°æ¶æ„Fabricå®ç°çš„JSIå®ç°äº†js å’Œ nativeçš„ç›´æ¥å…±äº«å†…å­˜è°ƒç”¨ï¼Œè€Œæ— éœ€å†ç»è¿‡Bridgeã€‚

- ç¬¬ä¸‰å±‚æ˜¯Nativeå±‚ï¼Œä¸»è¦æ¸²æŸ“åŸç”Ÿç»„ä»¶å’Œä¼ é€’äº‹ä»¶ã€‚Reactå†™çš„ **Virtual DOM èŠ‚ç‚¹æ˜¯åˆ©ç”¨`yoga`è§£æ**ï¼Œæ˜ å°„ä¸ºåŸç”Ÿç»„ä»¶ï¼Œæ‰€ä»¥èƒ½å®ç°ä¸€å¥—ä»£ç åœ¨ Android å’Œ iOSåŸç”Ÿç«¯ä½¿ç”¨ã€‚

Reactè‡ªèº«æ˜¯ä¸ç›´æ¥ç»˜åˆ¶UIçš„ï¼ŒUIç»˜åˆ¶æ˜¯éå¸¸è€—æ—¶çš„æ“ä½œï¼ŒåŸç”Ÿç»„ä»¶æœ€æ“…é•¿è¿™äº‹æƒ…ã€‚
:::tip
åœ¨ä¸€å®šç¨‹åº¦ä¸Šï¼ŒReact Nativeå’ŒNodeJSæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚å®ƒä»¬éƒ½æ˜¯é€šè¿‡æ‰©å±•JavaScript Engine, ä½¿å®ƒå…·å¤‡å¼ºå¤§çš„æœ¬åœ°èµ„æºå’ŒåŸç”Ÿæ¥å£è°ƒç”¨èƒ½åŠ›ï¼Œç„¶åç»“åˆJavaScriptä¸°å¯Œçš„åº“å’Œç¤¾åŒºå’ŒåŠå…¶ç¨³å®šçš„è·¨å¹³å°èƒ½åŠ›ï¼Œ æŠŠJavascriptçš„é­”åŠ›åœ¨æµè§ˆå™¨ä¹‹å¤–çš„åœ°æ–¹å……åˆ†å‘æŒ¥å‡ºæ¥ã€‚
:::

### Yogaå¼•æ“
**Yogaæ˜¯ä¸€ä¸ªåŸºäº *Flexbox* çš„è·¨å¹³å°å¸ƒå±€å¼•æ“**ï¼Œæœ€åˆæ˜¯Facebookåœ¨2014å¹´æ¨å‡ºçš„ä¸€ä¸ªCSSå¸ƒå±€çš„å¼€æºåº“ï¼Œ2016å¹´æ”¹ç‰ˆå¹¶æ›´åä¸ºYogaã€‚

**Flexbox**(CSS Flexible Box) æ˜¯ç”¨æ¥å¤„ç† web ä¸Šçš„å¤æ‚å¸ƒå±€ã€‚Yoga å¹¶æ²¡æœ‰å®ç°å…¨éƒ¨ CSS Flexboxã€‚
å®ƒçœç•¥äº†éå¸ƒå±€å±æ€§ï¼Œå¦‚è®¾ç½®é¢œè‰²ã€‚Yoga æ”¹è¿›äº†ä¸€äº› Flexbox çš„å±æ€§æ¥æä¾›æ›´å¥½çš„ä»å³åˆ°å·¦çš„æ”¯æŒã€‚æœ€åï¼ŒYoga å¢åŠ äº†ä¸€ä¸ªæ–°çš„æ¯”ä¾‹ï¼ˆAspectRatioï¼‰å±æ€§æ¥å¤„ç†åœ¨å¸ƒç½®æŸäº›å…ƒç´ å¦‚å›¾ç‰‡æ—¶å¸¸è§çš„éœ€æ±‚ã€‚

## RNæ˜¯å¦‚ä½•æ„é€ åº”ç”¨å¸ƒå±€çš„
åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆè¯´è¯´RNçš„å·¥ä½œæ–¹å¼ã€‚
### çº¿ç¨‹æ¨¡å‹
![RNå·¥ä½œæ–¹å¼](/images/rn-old-ui.jpeg)
RNä¸­æœ‰ä¸‰ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š
- MAIN Thread/UI Thread: ä¹Ÿå«UIçº¿ç¨‹ï¼Œè¿è¡ŒAndroid / iOSåº”ç”¨ç¨‹åºçš„ä¸»è¦åº”ç”¨ç¨‹åºçš„çº¿ç¨‹ï¼Œå®ƒå…·æœ‰è®¿é—®UIçš„æƒé™ï¼Œå¹¶ä¸”åªèƒ½é€šè¿‡æ­¤çº¿ç¨‹æ›´æ”¹UIã€‚
- Shadow Thread: æ˜¯RNä½¿ç”¨Reactåº“è¿›è¡Œå¸ƒå±€è®¡ç®—å’Œæ„é€  UI ç•Œé¢çš„çº¿ç¨‹ã€‚
- JS Thread: Reactç­‰JavaScriptä»£ç éƒ½åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç±»Native Modules çº¿ç¨‹ï¼Œä¸åŒçš„Native Moduleså¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ã€‚

### å¯åŠ¨è¿‡ç¨‹
çŸ¥é“äº†RNçš„çº¿ç¨‹å…³ç³»ä¹‹åï¼Œæ¥ä¸‹æ¥çœ‹RNæ˜¯æ€ä¹ˆè¿è¡Œçš„ã€‚

é¦–å…ˆå‘¢ï¼ŒApp å¯åŠ¨æ—¶åˆå§‹åŒ– React Native è¿è¡Œæ—¶ç¯å¢ƒï¼ˆå³Bridgeï¼‰ï¼ŒBridgeå‡†å¤‡å¥½ä»¥åå¼€å§‹Nativeæ¸²æŸ“ã€‚

é‚£ä¹ˆæ•´ä¸ªåˆå§‹åŒ– Bridge è¿‡ç¨‹åˆ†ä¸º4éƒ¨åˆ†ï¼š
- åŠ è½½ JavaScript ä»£ç ï¼šå¼€å‘æ¨¡å¼ä¸‹ä»ç½‘ç»œä¸‹è½½ï¼Œç”Ÿäº§ç¯å¢ƒä»è®¾å¤‡å­˜å‚¨ä¸­è¯»å–ã€‚
- åˆå§‹åŒ– Native Moduleï¼šæ ¹æ® Native Module æ³¨å†Œä¿¡æ¯ï¼ŒåŠ è½½å¹¶å®ä¾‹åŒ–æ‰€æœ‰ Native Moduleã€‚
- æ³¨å…¥ Native Module ä¿¡æ¯ï¼šå– Native Module æ³¨å†Œä¿¡æ¯ï¼Œä½œä¸ºå…¨å±€å˜é‡æ³¨å…¥åˆ° JS Context ä¸­ã€‚
- åˆå§‹åŒ– JavaScript å¼•æ“ï¼š å³ JavaScriptCoreã€‚

Bridge å»ºç«‹ä¹‹åï¼ŒJavaScript ä»£ç å¼€å§‹æ‰§è¡Œï¼Œæ¸²æŸ“ç”¨æˆ·ç•Œé¢å¹¶å®ç°ä¸šåŠ¡åŠŸèƒ½ã€‚

![RNå·¥ä½œæ–¹å¼2](/images/rn-new-ui.jpeg)

æ¸²æŸ“ç•Œé¢çš„è¿‡ç¨‹ï¼š

- JS çº¿ç¨‹å°†è§†å›¾ä¿¡æ¯(ç»“æ„ã€æ ·å¼ã€å±æ€§ç­‰) ä¼ é€’ç»™ Shadow çº¿ç¨‹ã€‚
- åˆ›å»ºå‡ºç”¨äºå¸ƒå±€è®¡ç®—çš„ Shadow Treeã€‚
- Shadow çº¿ç¨‹è®¡ç®—å¥½å¸ƒå±€ä¹‹åï¼Œå†å°†å®Œæ•´çš„è§†å›¾ä¿¡æ¯ï¼ˆåŒ…æ‹¬å®½é«˜ã€ä½ç½®ç­‰ï¼‰ä¼ é€’ç»™UIçº¿ç¨‹ï¼ŒUIçº¿ç¨‹æ®æ­¤åˆ›å»º Native Viewã€‚

ç”¨æˆ·åŠ¨ä½œåé¦ˆçš„è¿‡ç¨‹ï¼š
- å¯¹äºç”¨æˆ·è¾“å…¥ï¼Œåˆ™å…ˆç”±UIçº¿ç¨‹å°†ç›¸å…³ä¿¡æ¯æ‰“åŒ…æˆäº‹ä»¶æ¶ˆæ¯ä¼ é€’åˆ° Shadow çº¿ç¨‹ã€‚
- Shadowçº¿ç¨‹å†æ ¹æ® Shadow Tree å»ºç«‹çš„æ˜ å°„å…³ç³»ç”Ÿæˆç›¸åº”å…ƒç´ çš„æŒ‡å®šäº‹ä»¶ã€‚
- æœ€åå°†äº‹ä»¶ä¼ é€’åˆ° JS çº¿ç¨‹ï¼Œæ‰§è¡Œå¯¹åº”çš„ JS å›è°ƒå‡½æ•°ã€‚

## æ ¹æ®é¡¹ç›®å” æ¡¥æ¥
æˆ‘å‰é¢è®²äº†RNçš„åŸºæœ¬åŸç†ï¼Œæ˜ç™½ä»–æ˜¯æ€ä¹ˆè¿è¡Œçš„ã€‚é‚£ä¹ˆæ—¥å¸¸ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨RNå®Œæˆå¤§éƒ¨åˆ†å·¥ä½œï¼Œä½†æ˜¯å¦‚æœæƒ³ç”¨ä¸€äº›ç°æˆåŸç”Ÿä»£ç ï¼Œæˆ–è€…è®©åŸç”Ÿæ¥å¤„ç†ä¸€äº›é«˜æ€§èƒ½çš„å¤šçº¿ç¨‹ä»£ç æ—¶æ€ä¹ˆåŠï¼Ÿ

è¦å®ç°åŸç”Ÿä¸JSé€šä¿¡ï¼Œå°±è¦ä½¿ç”¨RNçš„Bridgeæ¥å®ç°ï¼Œè¿™é‡Œå°±éœ€è¦æˆ‘ä»¬è‡ªå·±å°è£…Bridgeã€‚åŒ…æ‹¬å’±ä»¬è‡ªå·±é¡¹ç›®ä¸­ç”¨åˆ°ç»§æ‰¿FIDOï¼Œå®‰å…¨é”®ç›˜ï¼ŒBuglyç­‰ç­‰çš„SDKéƒ½éœ€è¦ç”¨åˆ°æ¡¥æ¥ã€‚

æ¥ä¸‹æ¥æˆ‘å°±ä»ä»£ç å±‚é¢è®²è®²Bridgeï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬æˆ‘åœ¨é¡¹ç›®ä¸­é‡åˆ°çš„å‘ç‚¹ã€‚

### FIDOæ¨¡å—
FIDOæ¨¡å—è°ƒç”¨äº†ç¬¬ä¸‰æ–¹çš„SDKï¼Œç„¶åç”±åŸç”Ÿå®ç°éƒ¨åˆ†UIçš„äº¤äº’éƒ¨åˆ†ã€‚è¿™é‡Œåªéœ€è¦JSè°ƒç”¨åŸç”Ÿæä¾›çš„æ–¹æ³•ä»¥åŠJSç›‘å¬åŸç”Ÿæ–¹æ³•æä¾›çš„å›è°ƒã€‚
#### ä¸€ã€æ·»åŠ FIDOModules
FIDOModulesæ˜¯æ¡¥æ¥æ ¸å¿ƒçš„ä»£ç æ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­mobileæ˜¯å·¥ç¨‹åç§°ï¼Œè¿™é‡Œéšæ„æ·»åŠ çš„ã€‚
**Androidä»£ç **
```java
/**
 * android/app/src/main/java/com/mobile/FIDO/FIDOModules.java
 */
package com.mobile.FIDO;

import com.facebook.react.bridge.Arguments;
import com.facebook.react.bridge.Promise;
import com.facebook.react.bridge.ReactApplicationContext;
import com.facebook.react.bridge.ReactContext;
import com.facebook.react.bridge.ReactContextBaseJavaModule;
import com.facebook.react.bridge.ReactMethod;
import com.facebook.react.bridge.ReadableMap;
import com.facebook.react.bridge.UiThreadUtil;
import com.facebook.react.bridge.WritableMap;
import com.facebook.react.modules.core.DeviceEventManagerModule;
// ...

public class FIDOModules extends ReactContextBaseJavaModule{
    private final String SET_NAME = "FIDOModules";
    private final ReactApplicationContext reactContext;

    public FIDOManager(ReactApplicationContext reactContext) {
        super(reactContext);
        this.reactContext = reactContext;
    }

    // è¿™ä¸ªå‡½æ•°ç”¨äºè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²åå­—ï¼Œè¿™ä¸ªåå­—åœ¨ JavaScript ç«¯æ ‡è®°è¿™ä¸ªæ¨¡å—
    @Override
    public String getName() {
        return SET_NAME;
    }
    
    // è¦å¯¼å‡ºä¸€ä¸ªæ–¹æ³•ç»™ JavaScript ä½¿ç”¨ï¼ŒJava æ–¹æ³•éœ€è¦ä½¿ç”¨æ³¨è§£@ReactMethod
    @ReactMethod
    public void fidoInit(Promise promise) throws ClassNotFoundException{
        try {
            WritableMap map = Arguments.createMap();
            // ...
            promise.resolve(messageString);
        } catch (Exception e) {
            promise.reject("error", e);
        }
    }

    @ReactMethod
    public void fidoRegister(ReadableMap map) {
        // è·å–mapä¸­çš„æ•°æ®
        String userName = map.getString("userName");

        // å¦‚æœè¦åšä¸€äº›å»¶æ—¶çš„æ“ä½œï¼Œéœ€è¦åœ¨Androidçš„å­çº¿ç¨‹ä¸­å»è°ƒç”¨
        // å¦‚æœç”¨UIçº¿ç¨‹ï¼Œå°±ä¸ç”¨å†™
        UiThreadUtil.runOnUiThread(new Runnable() {
            @Override
            public void run() {
                // ...
            }
        });
    
    }

    // åŸç”Ÿæ¨¡å—å¯ä»¥åœ¨æ²¡æœ‰è¢«è°ƒç”¨çš„æƒ…å†µä¸‹å¾€ JavaScript å‘é€äº‹ä»¶é€šçŸ¥ã€‚
    // æœ€ç®€å•çš„åŠæ³•å°±æ˜¯é€šè¿‡RCTDeviceEventEmitterï¼Œè¿™å¯ä»¥é€šè¿‡ReactContextæ¥è·å¾—å¯¹åº”çš„å¼•ç”¨
    private void sendEvent(
        ReactContext reactContext,
        String eventName,
        @Nullable WritableMap params
    ) {
        reactContext
                .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class)
                .emit(eventName, params);
    }
    
    // å°è£…äº†ä¸€ä¸‹è¿”å›çš„å‚æ•°
    private void sendJSCode(String listenName, String title, String status, String res) {
        WritableMap params = Arguments.createMap();
        params.putString("msg", title);
        params.putString("status", status);
        params.putString("res", res);
        Log.e("ä¼ è¾“çš„æ•°æ®", "æ•°æ®"+params);
        sendEvent(this.reactContext, listenName, params);
    }

    public void onSuccess(int reqType, String response) {
        // åŸç”Ÿæ¨¡å—ç»™JSå‘é€äº‹ä»¶
        sendJSCode("register", "æ³¨å†ŒæˆåŠŸ", "0", response);
    }
    // ......
    // è¿™é‡Œåªè´´å‡ºäº†æ¡¥æ¥æ‰€éœ€çš„æ ¸å¿ƒä»£ç ï¼Œå…¶ä»–ä»£ç çœç•¥æ‰äº†
}
```
å¯¹åº”çš„iOSä»£ç å¦‚ä¸‹ï¼š
```c
#import <Foundation/Foundation.h>
#import <React/RCTBridgeModule.h>
#import <React/RCTEventEmitter.h>


NS_ASSUME_NONNULL_BEGIN

@interface FTFIDOManager : RCTEventEmitter <RCTBridgeModule,NSURLSessionDelegate,NSURLSessionDataDelegate,NSURLSessionTaskDelegate>

@property (nonatomic,strong)NSMutableData *responseData;

@end

NS_ASSUME_NONNULL_END
```
```c
// FIDOModules.m     çœç•¥æ‰.hæ–‡ä»¶

#define FT_FIDO_INIT fidoInit
#define FT_FIDO_REGISTER fidoRegister

// å£°æ˜æˆå‘˜å˜é‡ ...
@property (nonatomic, strong) NSString * username;

@implementation FTFIDOManager

// ä¸ºäº†å®ç°RCTBridgeModuleåè®®ï¼Œä½ çš„ç±»éœ€è¦åŒ…å«RCT_EXPORT_MODULE()å®
RCT_EXPORT_MODULE(FIDOModules)

RCT_REMAP_METHOD(FT_FIDO_INIT,
   resolver:(RCTPromiseResolveBlock)resolve
   rejecter:(RCTPromiseRejectBlock)reject
){
  // ...
  if(supportType){
    resolve(supportType);
  }else{
    NSError *error = [NSError errorWithDomain:NSCocoaErrorDomain code:1 userInfo:@{@"error":@"è·å–å¤±è´¥"}];
    reject(@"no_events", @"There were no events", error);
  }
}

RCT_EXPORT_METHOD(FT_FIDO_REGISTER:(NSDictionary *) json){
    // åœ¨ocä¸­ï¼Œæ”¶åˆ°çš„æ˜¯ä¸€ä¸ªå­—å…¸
    userName = [json objectForKey:@"userName"];
}

#pragma ç»™jsç«¯å‘é€äº‹ä»¶
// è¿™é‡Œéœ€è¦æ³¨å†Œäº‹ä»¶
- (NSArray<NSString *> *)supportedEvents
{
  return @[@"register"];
}

// å°è£…äº†ä¸€ä¸‹è¿”å›çš„å‚æ•°
- (void)sendJSCode:(NSString *)listenName
             title:(NSString *)title
            status:(NSString *)status
               res:(NSString *)res
{
  [self sendEventWithName:listenName body:@{@"msg": title,@"status": status,@"res":res}];
} 

- (void)onSuccess:(NSString *)uafResponse
{
    // åŸç”Ÿæ¨¡å—ç»™JSå‘é€äº‹ä»¶
    [self sendJSCode:@"register" title:@"æ³¨å†ŒæˆåŠŸ" status:@"0" res:res];
}
@end
```
#### äºŒã€æ³¨å†Œæ¨¡å—
åœ¨Androidä¸­éœ€è¦åœ¨åº”ç”¨çš„Packageç±»çš„`createNativeModules`æ–¹æ³•ä¸­æ·»åŠ è¿™ä¸ªæ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰è¢«æ³¨å†Œï¼Œåˆ™åœ¨JavaScriptä¸­æ— æ³•è®¿é—®åˆ°ã€‚
```java
/**
 * android/app/src/main/java/com/mobile/FIDO/FIDOPackage.java
 */
package com.by_mobile.FTFIDO;

import com.facebook.react.ReactPackage;
import com.facebook.react.bridge.NativeModule;
import com.facebook.react.bridge.ReactApplicationContext;
import com.facebook.react.uimanager.ViewManager;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

public class FIDOPackage implements ReactPackage {
    // ç”¨æ¥åœ¨æ³¨å†Œå¯¼å…¥RNçš„åŸç”Ÿæ¨¡å—
    @Override
    public List<NativeModule> createNativeModules(ReactApplicationContext reactContext) {
        List<NativeModule> modules = new ArrayList<>();
        // è¿™é‡Œæ·»åŠ FIDOModules
        modules.add(new FIDOModules(reactContext));
        return modules;
    }

    // æ·»åŠ è‡ªå®šä¹‰çš„è§†å›¾ç®¡ç†ç±»
    @Override
    public List<ViewManager> createViewManagers(ReactApplicationContext reactContext) {
        return Collections.emptyList();
    }
```
æ¥ä¸‹æ¥éœ€è¦åˆ°`MainApplication.java`ä¸­æ·»åŠ ï¼Œå› ä¸ºAPPå¯åŠ¨æ—¶ï¼Œå…ˆæ‰§è¡Œ`MainApplication.java`ï¼Œç„¶åå†æ‰§è¡Œ`MainActivity.java`åˆ›å»ºä¸€ä¸ª`MainActivity`ã€‚
```java
/**
 * android/app/src/main/java/com/mobile/MainApplication.java
 */
package com.mobile;
import com.mobile.FIDO.FIDOPackage;

public class MainApplication extends Application implements ReactApplication {

  private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {
    ...
    @Override
    protected List<ReactPackage> getPackages() {
      @SuppressWarnings("UnnecessaryLocalVariable")
      List<ReactPackage> packages = new PackageList(this).getPackages();
      packages.add(new FIDOPackage());
      return packages;
    }
    ...
  };
  ...
}
```
#### ä¸‰ã€JavaScript ç«¯å°è£…è°ƒç”¨
ä¸€èˆ¬å°†RNæ¡¥æ¥éƒ¨åˆ†çš„JavaScriptä»£ç å°è£…èµ·æ¥ï¼Œä½¿ç”¨çš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹å°±è¡Œäº†ã€‚
```typescript jsx
import {
  NativeModules,
  NativeEventEmitter,
  DeviceEventEmitter,
  Platform,
} from 'react-native';


const {FIDOModules} = NativeModules;

const {fidoInit, fidoRegister} = FIDOModules;

let EventEmitter = Platform.OS === 'ios'
    ? new NativeEventEmitter(FIDOModules)
    : DeviceEventEmitter;
let register;

export async function initFido(fn:Function) {
  try {
    let msg:Array<{title: string}>= await fidoInit();
    ...
    fn && fn(msg);
  } catch (e) {
    fn && fn(e);
  }
}

export async function registerFido(fn: (e: Event) => void) {
  ...
  await fidoRegister(options);
  register && register.remove();
  register: EventEmitter = EventEmitter.addListener('register', (e: Event) => {
    fn && fn(e);
  });
}
```
### SafeKeyæ¨¡å—
å®‰å…¨é”®ç›˜æ¨¡å—æœ‰ä¸€ä¸ªç‰¹æ®Šçš„éœ€æ±‚ï¼Œè¿™è¾¹ç”±äºé”®ç›˜æ˜¯åœ¨TEEç³»ç»Ÿå®ç°çš„ï¼Œç„¶åè¾“å…¥æ¡†éœ€è¦ç”¨RNè§†å›¾ç»„ä»¶ä¸­çš„TextInputã€‚ç°åœ¨éœ€è¦ä½¿ç”¨`findNodeHandle`å°†RNä¸­TextInputç»„ä»¶çš„tagå€¼
è·å–åˆ°ï¼Œç„¶åä¼ é€’ç»™Nativeé‚£è¾¹ï¼ŒNativeæ”¶åˆ°åé€šè¿‡tagå€¼å†è·å–å¯¹åº”çš„ç»„ä»¶å¯¹è±¡ï¼Œæœ€åå’Œå®‰å…¨é”®ç›˜ç»‘å®šã€‚æ•´ä¸ªå®ç°çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

:::tip è·å–uimanagerç±»
Androidéƒ¨åˆ†çš„ä»£ç ä¸­æ³¨å†Œæ¨¡å—ï¼Œç»™JSæä¾›è°ƒç”¨æ–¹æ³•ç­‰éƒ½å’ŒFIDOå¤§åŒå°å¼‚ã€‚è¿™é‡Œåªæ˜¯å±•ç¤ºtagéœ€è¦çš„æ ¸å¿ƒä»£ç ï¼ï¼ï¼

Androidè¿™é‡Œéœ€è¦åœ¨`com`æ–‡ä»¶å¤¹ä¸‹åœ¨åˆ›å»º`facebook/react/uimanager/`æ–‡ä»¶å¤¹ï¼Œå°†`SafeKeyModule.java`æ–‡ä»¶å†™åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæ–¹ä¾¿è·å–åˆ°RNçš„
`uimanager`ç±»ã€‚
:::
```java
/**
 * android/app/src/main/java/com/facebook/react/uimanager/SafeKeyModule.java
 */   
package com.facebook.react.uimanager;

import com.facebook.react.bridge.Arguments;
import com.facebook.react.bridge.Callback;
import com.facebook.react.bridge.ReactApplicationContext;
import com.facebook.react.bridge.ReactContext;
import com.facebook.react.bridge.ReactContextBaseJavaModule;
import com.facebook.react.bridge.ReactMethod;
import com.facebook.react.bridge.ReadableMap;
import com.facebook.react.bridge.UiThreadUtil;
import com.facebook.react.bridge.WritableMap;
import com.facebook.react.modules.core.DeviceEventManagerModule;
import com.facebook.react.uimanager.common.ViewUtil;
import com.facebook.react.views.textinput.ReactEditText;

public class SafeKeyModule extends ReactContextBaseJavaModule {

    private static final String SET_NAME = "SafeKeyboard";
    
    public SafeKeyModule(@Nonnull ReactApplicationContext reactContext) {
        super(reactContext);
        this.reactContext = reactContext;
    }

    @Override
    public String getName() {return SET_NAME;}

    /**
     * è·å–reactTag  RNç«¯é€šè¿‡ findNodeHandle()è·å–
     * è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œä¹Ÿæ˜¯æ•´ä¸ªNativeè°ƒç”¨RNç»„ä»¶çš„å…³é”®
     * @param id
     */
    private ReactEditText getEditById(int id) {
        UIViewOperationQueue uii = this.getReactApplicationContext().getNativeModule(UIManagerModule.class).getUIImplementation().getUIViewOperationQueue();
        return (ReactEditText) uii.getNativeViewHierarchyManager().resolveView(id);
    }

    @ReactMethod
    public void initSafeKeyboard(ReadableMap msg){
        UiThreadUtil.runOnUiThread(new Runnable() {
            @Override
            public void run() {
                // è¿™é‡Œè·å–TextInputç»„ä»¶çš„tag
                final int reactTag = msg.getInt("reactTag");
                // è¿™é‡Œæ ¹æ®TextInputç»„ä»¶è·å–å¯¹è±¡
                textInput = getEditById(reactTag);
                ...
            }
        });
    }
}
```

Objective-cå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š
```c
#import "RFTSafeKeyModule.h"
#import <React/RCTUIManager.h>
#import <React/RCTBaseTextInputView.h>
#import <React/RCTBridge.h>

#define RFT_KEYBOARD_INIT initSafeKeyboard

@interface RFTSafeKeyModule()
@property (strong,nonatomic) UITextField * textInput;
@end

@implementation RFTSafeKeyModule
@synthesize bridge = _bridge;

RCT_EXPORT_MODULE(SafeKeyboard)

RCT_EXPORT_METHOD(RFT_KEYBOARD_INIT:(nonnull NSDictionary *)msg){
    // è¿™é‡Œuiéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨
  dispatch_async(dispatch_get_main_queue(), ^{
    NSNumber *reactTag = [msg objectForKey:@"reactTag"];

    // è·å–input
    if(reactTag){
        // è·å–TextInputçš„æ ¸å¿ƒä»£ç 
      self.textInput = (UITextField *)(((RCTBaseTextInputView*)[self->_bridge.uiManager viewForReactTag:reactTag]).backedTextInputView);
      
      // æ”¹å˜è¾“å…¥å…‰æ ‡çš„é¢œè‰²
      if([noChangeNumber integerValue] == 0){
        self.textInput.tintColor = [UIColor colorWithWhite:1.0 alpha:0];
      }
    }
  });
}
@end
```

JavaScriptä»£ç å®ç°ï¼š
```typescript jsx
import * as React from 'react';
import {
  NativeModules,
  TextInput,
  findNodeHandle,
  NativeAppEventEmitter,
} from 'react-native';

const {SafeKeyboard} = NativeModules;
const {
  initSafeKeyboard
} = SafeKeyboard;

export default const SafeInput:React.FC = ():JSX.element => {
  const refs = React.useRef<null!>();

  React.useEffect(() => {
    setTimeout(() => {
      initSafeKeyboard({
        reactTag: findNodeHandle(refs),
      })
    },200)
  },[]);

  return (
    <TextInput
        ref={refs}
        ...
      />
  );
}
```

### ç»“è¯­
å…³äºRNçš„æ¡¥æ¥æˆ‘è¿™é‡Œåªæ˜¯è®²äº†ä¸€å°éƒ¨åˆ†ï¼Œå…¶ä¸­æœ‰äº›ç‰¹æ®Šçš„éœ€æ±‚å’Œçˆ¬è¿‡çš„å‘ä¹Ÿä¸æ­¢è¿™ä¸€ç‚¹ï¼Œæ›´è¦å®è·µçš„æ¢ç´¢å’Œè§£å†³ã€‚æ¯”å¦‚è¿˜æœ‰è°ƒç”¨åŸç”ŸUIç»„ä»¶ç­‰å…¶ä»–ä½¿ç”¨æ–¹æ³•ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒRNçš„å®˜ç½‘ï¼Œç†è§£æ‰€æœ‰çš„åŸç†å’Œæµç¨‹ä»¥åï¼Œæ‰èƒ½å†™å‡ºæ›´ä¼˜ç§€çš„ä»£ç ã€‚

## ç›¸å…³é“¾æ¥
- [React Nativeå®˜ç½‘](https://reactnative.dev/)
- [React Nativeå¦‚ä½•æ„å»ºåº”ç”¨å¸ƒå±€](https://www.freecodecamp.org/news/how-react-native-constructs-app-layouts-and-how-fabric-is-about-to-change-it-dd4cb510d055/)









                                             





