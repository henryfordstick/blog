# 01 | V8 是如何执行一段 JS 代码的
V8 是由 Google 开发的开源 JavaScript 引擎，也被称为虚拟机，模拟实际计算机各种功能来实现代码的编译和执行。那么，要想搞清楚 V8 内部的工作流程和原理，我们可以从分析计算机对语言的编译和执行过程入手。
## 一、V8 执行代码的流程
V8 执行 JS 代码的核心流程主要分为两步：**编译** 和 **执行**。首先需要将 JS 代码转化成低级中间代码或者机器能够理解的机器代码，然后再执行输出结果。

## 二、为什么要高级语言
CPU 看成是一个非常小的运算机器，我们通过**二进制的指令**和 CPU 进行沟通。工程师们为 CPU 提供了一大堆指令，这一大堆指令称为**指令集**，也就是**机器语言**。
<br/>但是二进制难以阅读和记忆，则将二进制指令集转换为人类可以识别和记忆的符号，这就是**汇编指令集**。不同的 CPU 有着不同的指令集，如：intel，ARM，MIP5等。
所以在编写汇编代码时，我们还需要了解和处理器架构相关的硬件知识。

所以就生出了如：C、C++、Java、C#、Python、JavaScript 等高级语言。

高级语言和汇编语言一样，处理器也不能直接识别由其所编写的代码，所以执行的方式有两种：**解释执行**和**编译执行**。
- 解释执行（源代码 ==> 解析器 ==> 中间代码 ==> 解释器 ==> 结果）**启动快，执行慢**
![解释执行流程图](/images/V8-inter.jpg)
- 编译执行 (源代码 ==> 解析器 ==> 中间代码 ==> 编译器 ==> 二进制代码 ==> 执行结果)**启动慢，执行快**
![编译执行流程图](/images/V8-Complied.jpg)
:::tip 字节码和机器码的区别
首先明确一点就是字节码不是机器码！！！
- 字节码是一种中间代码，需要通过解释器才能称为机器码
- 机器码是可以被CPU执行的二进制码
:::

## 三、V8 是怎么执行 JS 代码的
V8 采用混合编译执行和解释执行这两种手段。**我们把这种混合使用编译器和解释器的技术称为 JIT（Just In Time）技术**。
![V8执行一段JavaScript流程图](/images/8a34ae8c1a7a0f87e19b1384a025e354.jpg)
- V8 会接收到要执行的 JavaScript 源代码，只是一堆字符串，需要结构化这段字符串。
- V8 源代码的结构化之后，就生成了**抽象语法树 (AST)**。
- 在生成 AST 的同时，V8 还会生成相关的作用域，作用域中存放相关变量。
- 接下来就可以生成字节码了，字节码是介于 AST 和机器代码的中间代码。
- 解释器就登场了，它会按照顺序解释执行字节码，并输出执行结果。
- 在解释执行字节码的过程中，如果发现了某一段代码会被重复多次执行，那么监控机器人就会将这段代码标记为热点代码。
- V8 就会将热点代码丢给优化编译器，优化编译器会在后台将字节码编译为二进制代码，然后进行优化。
- 如果下面再执行到这段代码时，V8 会优先选择优化之后的二进制代码，这样代码的执行速度就会大幅提升。
:::warning 反优化
JavaScript 是一种非常灵活的动态语言，对象的结构和属性是可以在运行时任意修改的。

而经过优化编译器优化过的代码只能针对某种固定的结构，一旦在执行过程中，对象的结构被动态修改了，那么优化之后的代码势必会变成无效的代码。

这时候优化编译器就需要执行反优化操作，经过反优化的代码，下次执行时就会回退到解释器解释执行。
:::

## 四、总结
V8 执行一段 JavaScript 代码所经历的主要流程：
- 初始化基础环境
- 解析源码生成 AST 和作用域
- 依据 AST 和作用域生成字节码
- 解释执行字节码
- 监听热点代码
- 优化热点代码为二进制的机器代码
- 反优化生成的二进制机器代码



